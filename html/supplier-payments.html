<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enterprise Portal | Payment Status</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/supplier-payments.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  </head>
  <body>
    <nav class="dashboard-navbar">
      <div class="logo">
        <a href="supplier-dashboard.html">Washing Unit (Pvt) Ltd<span class="dot-orange">.</span></a>
      </div>
      <div class="user-menu">
        <div class="nav-actions">
          <a href="supplier-dashboard.html" class="btn-text-sm"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</a>
          <a href="../php/supplier-logout.php" class="btn-logout" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
      </div>
    </nav>

    <main class="dashboard-container">
      <header class="page-header-row">
        <div>
          <h2>Payment Status</h2>
          <p>Track invoice approvals and incoming settlements.</p>
        </div>
        <div class="header-actions">
          <div class="select-wrapper-sm">
            <select class="filter-select" id="invoiceFilter">
              <option value="all">All Invoices</option>
              <option value="Unpaid">Unpaid / Pending</option>
              <option value="Paid">Settled</option>
            </select>
            <i class="fa-solid fa-filter select-icon-sm"></i>
          </div>
        </div>
      </header>

      <section class="summary-row">
        <div class="summary-card card-orange">
          <div class="icon-box"><i class="fa-solid fa-hourglass-half"></i></div>
          <div><h3>Pending Clearing</h3><p class="amount" id="pendingClearing">...</p></div>
        </div>
        <div class="summary-card card-green">
          <div class="icon-box"><i class="fa-solid fa-coins"></i></div>
          <div><h3>Total Settled (This Month)</h3><p class="amount" id="settledMonth">...</p></div>
        </div>
      </section>

      <div class="table-card">
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>PO Reference</th>
                <th>Invoice Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="paymentTable"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      function money(v) { return Number(v || 0).toLocaleString(undefined, {minimumFractionDigits: 2}); }
      function fmtDate(iso) { if(!iso) return "-"; const d = new Date(iso); return isNaN(d.getTime()) ? iso : d.toLocaleDateString(); }
      
      function badgeClass(status) {
        const s = String(status).toLowerCase();
        if(s === "paid") return "badge-success";
        if(s === "approved") return "badge-success"; // Approved is also green
        if(s === "pending") return "badge-warning";
        if(s === "verifying") return "badge-warning"; 
        if(s === "rejected" || s === "cancelled") return "badge-danger";
        return "badge-neutral";
      }

      function escapeHtml(str) { return String(str ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

      async function loadPayments() {
        const filter = document.getElementById("invoiceFilter").value;
        const tbody = document.getElementById("paymentTable");
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-3">Loading...</td></tr>';

        try {
          const res = await fetch(`../php/supplier-get-payments.php?filter=${encodeURIComponent(filter)}`, { credentials: "same-origin" });
          if(res.status === 401) { window.location.href = "supplier-login.html"; return; }
          const data = await res.json();
          
          if(!data.ok) throw new Error(data.error || "Failed");

          document.getElementById("pendingClearing").textContent = "$" + money(data.summary?.pendingClearing);
          document.getElementById("settledMonth").textContent = "$" + money(data.summary?.settledThisMonth);

          tbody.innerHTML = "";
          if(!data.rows?.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-3">No invoices found.</td></tr>'; return; }

          data.rows.forEach(row => {
            const status = row.status || "Pending";
            const sLower = status.toLowerCase();
            
            // âœ… FIXED LOGIC: Allow buttons for 'approved' status too!
            // This ensures buttons stay visible after Admin approves, until Supplier clicks "Done"
            const canAct = sLower === "pending" || sLower === "verifying" || sLower === "approved";
            
            let actions = `<span style="color:#94a3b8; font-size:0.85rem;">-</span>`;
            
            if (canAct) {
                // Change button text based on status
                const doneText = sLower === "approved" ? "Confirm Receipt" : "Done";

                actions = `
                  <button class="btn-icon" onclick="updateInvoice(${row.invoiceId}, 'Paid')" 
                          title="Confirm Payment Received" style="color:#16a34a; background:#f0fdf4; border:none; padding:6px 10px; margin-right:5px; border-radius:6px; cursor:pointer;">
                    <i class="fa-solid fa-check"></i> ${doneText}
                  </button>
                  <button class="btn-icon" onclick="updateInvoice(${row.invoiceId}, 'Rejected')" 
                          title="Decline/Reject" style="color:#ef4444; background:#fef2f2; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
                    <i class="fa-solid fa-xmark"></i> Reject
                  </button>
                `;
            } else if (sLower === 'paid') {
                actions = `<span style="color:#16a34a; font-size:0.85rem;"><i class="fa-solid fa-check-circle"></i> Completed</span>`;
            } else if (sLower === 'rejected') {
                actions = `<span style="color:#ef4444; font-size:0.85rem;"><i class="fa-solid fa-circle-xmark"></i> Declined</span>`;
            }

            tbody.insertAdjacentHTML("beforeend", `
              <tr>
                <td class="fw-bold" style="color:#3b82f6;">${escapeHtml(row.invoice_number)}</td>
                <td>${escapeHtml(row.po_reference)}</td>
                <td>${fmtDate(row.invoice_date)}</td>
                <td class="fw-amount" style="font-weight:700;">$${money(row.totalAmount)}</td>
                <td><span class="badge ${badgeClass(status)}">${escapeHtml(status)}</span></td>
                <td class="text-right">${actions}</td>
              </tr>
            `);
          });

        } catch(err) { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${err.message}</td></tr>`; }
      }

      async function updateInvoice(id, action) {
        // action will be 'Paid' or 'Rejected'
        let msg = action === 'Paid' ? "Confirm you have received this payment?" : "Are you sure you want to REJECT this invoice?";
        if(!confirm(msg)) return;

        try {
          const res = await fetch("../php/supplier-update-invoice.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            // Note: Sending 'Paid' or 'Rejected' as the status directly
            body: new URLSearchParams({ invoiceId: id, status: action }), 
            credentials: "same-origin"
          });
          const data = await res.json();
          if(!res.ok || data.error) throw new Error(data.error || "Update failed");
          
          alert("Status Updated to " + action);
          loadPayments(); 
        } catch(err) { alert(err.message); }
      }

      document.getElementById("invoiceFilter").addEventListener("change", loadPayments);
      document.addEventListener("DOMContentLoaded", loadPayments);
    </script>
  </body>
</html>