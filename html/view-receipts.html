<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enterprise Portal | Payment Receipts</title>

    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/view-receipts.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="dashboard-navbar">
      <div class="logo">
        <a href="supplier-dashboard.html"
          >Washing Unit (Pvt) Ltd<span class="dot-orange">.</span></a
        >
      </div>

      <div class="user-menu">
        <div class="nav-actions">
          <a href="supplier-dashboard.html" class="btn-text-sm">
            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
          </a>
          <a
            href="../php/supplier-logout.php"
            class="btn-logout"
            title="Logout"
          >
            <i class="fa-solid fa-right-from-bracket"></i>
          </a>
        </div>
      </div>
    </nav>

    <main class="dashboard-container">
      <header class="page-header-row">
        <div>
          <h2>Remittance Advice</h2>
          <p>Download official receipts for settled payments.</p>
        </div>

        <div class="header-actions">
          <div class="input-wrapper-sm">
            <i class="fa-regular fa-calendar input-icon-sm"></i>
            <input type="month" class="date-filter" id="monthFilter" />
          </div>
        </div>
      </header>

      <div class="table-card">
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Receipt ID</th>
                <th>Payment Date</th>
                <th>Transaction Ref</th>
                <th>Details</th>
                <th>Amount Paid</th>
                <th class="text-right">Download</th>
              </tr>
            </thead>
            <tbody id="receiptTable">
              <tr><td colspan="6" class="text-center p-3">Loading receipts...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      const tableBody = document.getElementById("receiptTable");
      const monthInput = document.getElementById("monthFilter");

      // Set current month by default
      const now = new Date();
      const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
      monthInput.value = currentMonth;

      // 1. Formatting Helpers
      function money(v) {
        return Number(v || 0).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      function fmtDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        return isNaN(d.getTime()) ? iso : d.toLocaleDateString(undefined, {
          year: "numeric", month: "short", day: "2-digit"
        });
      }

      // 2. Fetch Data
      async function loadReceipts() {
        const month = monthInput.value;
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Loading...</td></tr>';

        try {
          const res = await fetch(`../php/supplier-get-receipts.php?month=${month}`, {
            credentials: "same-origin"
          });

          if (res.status === 401) {
            window.location.href = "supplier-login.html";
            return;
          }

          const data = await res.json();
          if (!res.ok || data.error) throw new Error(data.error || "Failed to load");

          renderRows(data.rows || []);

        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">${err.message}</td></tr>`;
        }
      }

      // 3. Render Rows
      function renderRows(rows) {
        tableBody.innerHTML = "";

        if (rows.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-muted" style="text-align:center; padding:20px;">No receipts found for this month.</td></tr>`;
          return;
        }

        rows.forEach(row => {
          const refNo = row.refNo || `RCPT-${row.receiptId}`;
          const transRef = `TRANS-${String(row.transactionId).padStart(4, '0')}`;
          
          // Google Drive Link Logic
          const btnHtml = row.driveLink 
            ? `<a href="${row.driveLink}" target="_blank" class="btn-download" title="View PDF">
                 <i class="fa-solid fa-file-arrow-down"></i> PDF
               </a>`
            : `<span class="text-muted" style="font-size:0.85rem;">Unavailable</span>`;

          tableBody.insertAdjacentHTML("beforeend", `
            <tr>
              <td class="fw-bold" style="color:#3b82f6;">${refNo}</td>
              <td class="text-main">${fmtDate(row.receiptDate)}</td>
              <td>${transRef}</td>
              <td>
                <div style="font-size:0.85rem; color:#64748b; max-width:250px; white-space:normal;">
                  ${row.stockDetails || "Payment Settlement"}
                </div>
              </td>
              <td class="fw-amount" style="font-weight:700;">Rs ${money(row.amount)}</td>
              <td class="text-right">${btnHtml}</td>
            </tr>
          `);
        });
      }

      // Event Listeners
      monthInput.addEventListener("change", loadReceipts);
      document.addEventListener("DOMContentLoaded", loadReceipts);
    </script>
  </body>
</html>